#!/bin/false
### --SOURCE-- this script !!!

### Use this to initialize the Python-AWS-CDK project .. and build the CDK-deployables.

### --------------------------------------------------------------------------------

### SECTION: Settings

export BUILDPLATFORM="linux/amd64"
export DOCKER_DEFAULT_PLATFORM="${BUILDPLATFORM}"
export TARGETPLATFORM="${DOCKER_DEFAULT_PLATFORM}"

### --------------------------------------------------------------------------------

echo "ðŸŽ¬ initialize .venv"

python3 -m venv .venv
.   .venv/bin/activate
sleep 2

echo "ðŸŽ¬ upgrade pip3"
python3 -m pip install --upgrade pip

echo "ðŸŽ¬ install pip-tools and generate requirements.txt"
python3 -m pip install pip-tools
python3 -m piptools compile --quiet --resolver=backtracking requirements.in
python3 -m piptools sync requirements.txt

pip install -r requirements.txt
pip install -r requirements-dev.txt

echo "ðŸŽ¬ Node.JS: npm install --include-dev"
npm i --include-dev

### --------------------------------------------------------------------------------

### SECTION: DERIVED-Settings

branch=$(git branch --show-current)
GITHUB_REPOSITORY=$(git remote get-url origin | sed -n 's#.*/\([^.]*\)\.git#\1#p')

echo "branch=${branch}"
echo "GITHUB_REPOSITORY=${GITHUB_REPOSITORY}"

### --------------------------------------------------------------------------------

echo "ðŸŽ¬ cdk-synth: build CDK-deployables"
sleep 2
npx cdk synth -c git_branch=${branch} -c git_repo=${GITHUB_REPOSITORY} -o cdk.out --quiet

# EoF
