#!/bin/bash -f

### Will clean ALL temporary and generated files.
### Will also DESTROY the deployed stacks.

### -----------------------------------------------------------

### SECTION: Settings

### -----------------------------------------------------------
### @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
### -----------------------------------------------------------

### SECTION: Reading configuration-settings FILE.

SCRIPTFOLDER=$(dirname -- "$0")
SCRIPTNAME=$(basename -- "$0")
echo "SCRIPTFOLDER = '${SCRIPTFOLDER}'"
echo "SCRIPTNAME = '${SCRIPTNAME}'"
if [ -e "$(pwd)/${SCRIPTFOLDER}" ]; then
    echo "Detected Relative-Path for script".
    SCRIPTFOLDER_FULLPATH="$(pwd)/${SCRIPTFOLDER}"
else
    echo "Detected Absolute-Path for script".
    SCRIPTFOLDER_FULLPATH="${SCRIPTFOLDER}"
fi
echo "SCRIPTFOLDER_FULLPATH = '${SCRIPTFOLDER_FULLPATH}'"

### -----------------------------------------------------------

CommonSettingsFile="./common-settings.sh"
if [ ! -e ${CommonSettingsFile} ]; then
    CommonSettingsFile="${SCRIPTFOLDER_FULLPATH}/${CommonSettingsFile}"
    if [ ! -e ${CommonSettingsFile} ]; then
        echo "ERROR: ${CommonSettingsFile} is missing"
        exit 9
    fi
fi
. ${CommonSettingsFile}

###--------------------------------------------------------

. ${SCRIPTFOLDER_FULLPATH}/checkStackStatus.sh

###--------------------------------------------------------
###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
###--------------------------------------------------------

### 1st destroy the stacks, before .venv node_modules and cdk.out are WIPED out.
echo ''
echo \
cdk destroy --role-arn "arn:aws:iam::${AWSACCOUNTID}:role/${DeploymentRoleName}" ${AWSPROFILEREGION}
cdk destroy --role-arn "arn:aws:iam::${AWSACCOUNTID}:role/${DeploymentRoleName}" ${AWSPROFILEREGION}

waitForCompleteDeletionOfStack ${ClamAV_CDK_StackName}

echo \
aws cloudformation delete-stack --stack-name ${StackName_DeploymentRole}  ${AWSPROFILEREGION}
aws cloudformation delete-stack --stack-name ${StackName_DeploymentRole}  ${AWSPROFILEREGION}


### --------------------------------------------------------------------------------

### SECTION: Clean local files.. .. !!! ONLY AFTER DESTROYING THE STACKS !!!
if [ -e .venv ]; then
    while read -r -t 1; do read -r -t 1; done
    read -p "Type Y|y|YES|yes to WIPE-OUT everything and start afresh? (<Cntl-C> to Abort!!) [Nn] >> " ANS
    if [ "${ANS}" == "Y" ] || [ "${ANS}" == "y" ] || [ "${ANS}" == "YES" ] || [ "${ANS}" == "yes" ]; then
        \rm -rf .venv node_modules package-lock.json cdk.out cdk/__pycache__ cdk/lib/__pycache__
    else
        echo "Aborted !!!!!!!!!"
        exit 9
    fi
fi

### --------------------------------------------------------------------------------

docker system prune --all --force
docker volume prune --all --force

### --------------------------------------------------------------------------------

### EoScript