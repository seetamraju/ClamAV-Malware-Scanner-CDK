#!/bin/bash -f

### Creates an IAM-Role to be used by you, when running CDK-Deploy.
### Per AWS  Best-Practices, do -NOT- deploy (or run `cdk deploy` command) while logged in with your AWS-Root-Account or with full Administrative privileges.


# This license BELOW applies to all content within ./test-deploy-to-aws
# subfolder-tree, as long as it does NOT conflict with the LICENSE defined
# in the LICENSE-file that is located in the topmost folder of this Git-Repo.
# ________________________________________________________________________
# BSD 3-Clause License

# Copyright (c) 2019, org.ASUX
# All rights reserved.

# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:

# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the following disclaimer.

# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.

# 3. Neither the name of the copyright holder nor the names of its
#    contributors may be used to endorse or promote products derived from
#    this software without specific prior written permission.

# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

### -----------------------------------------------------------

### SECTION: Settings

CFT_Filename="./etc/cdk-deploy-iam-role-CFT.yaml"
### The following are NOW DEFINED inside the `./bin/common-settings.sh` file.
# DeploymentRoleName="ClamAV-Malware-Scanner-CDKDeploy"
# StackName_DeploymentRole="Role-${DeploymentRoleName}"
# StackName_DeploymentRole="ClamAV-Malware-Scanner-CDKDeployRole"
# CFT_Filename=./${StackName_DeploymentRole}-CFT.yaml

###--------------------------------------------------------
###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
###--------------------------------------------------------

### SECTION: Reading configuration-settings FILE.

SCRIPTFOLDER=$(dirname -- "$0")
SCRIPTNAME=$(basename -- "$0")
echo "SCRIPTFOLDER = '${SCRIPTFOLDER}'"
echo "SCRIPTNAME = '${SCRIPTNAME}'"
if [ -e "$(pwd)/${SCRIPTFOLDER}" ]; then
    echo "Detected Relative-Path for script".
    SCRIPTFOLDER_FULLPATH="$(pwd)/${SCRIPTFOLDER}"
else
    echo "Detected Absolute-Path for script".
    SCRIPTFOLDER_FULLPATH="${SCRIPTFOLDER}"
fi
echo "SCRIPTFOLDER_FULLPATH = '${SCRIPTFOLDER_FULLPATH}'"
CWD=$(pwd)
echo "Current Working directory = ${CWD}"

# pushd . > /dev/null

### -----------------------------------------------------------

CommonSettingsFile="./common-settings.sh"
if [ ! -e ${CommonSettingsFile} ]; then
    CommonSettingsFile="${SCRIPTFOLDER_FULLPATH}/${CommonSettingsFile}"
    if [ ! -e ${CommonSettingsFile} ]; then
        echo "ERROR: ${CommonSettingsFile} is missing"
        exit 9
    fi
fi
. ${CommonSettingsFile}

###--------------------------------------------------------
###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
###--------------------------------------------------------

### SECTION: Derived Variables

CFT_Parameters=(
    ParameterKey="ENV",ParameterValue="${ENV}"
    ParameterKey="RoleName",ParameterValue="${DeploymentRoleName}"
    ParameterKey="PermissionsBoundaryPolicyARN",ParameterValue="${BOUNDARYPOLICY}"
)

### -----------------------------------------------------------

Capabilities=CAPABILITY_NAMED_IAM   ### ATTENTION:  Note: this is a UNIQUE capability (with _NAMED_ within its name)

echo    \
aws cloudformation describe-stacks --stack-name ${StackName_DeploymentRole} ${AWSPROFILEREGION}
aws cloudformation describe-stacks --stack-name ${StackName_DeploymentRole} ${AWSPROFILEREGION} >& /dev/null
        ### describe-stacks returns "254" (non-zero) value if NO SUCH STACK.
        ### describe-stacks returns "0" if STACK EXISTS.
if [ $? -ne 0 ]; then

    echo "[✅] No such stack exists."

    printf "\e[2m%s \e[22m" $( echo \
    aws cloudformation create-stack \
        --stack-name ${StackName_DeploymentRole}   \
        --no-disable-rollback       \
        --output json               \
        --template-body file://${CFT_Filename}  \
        --parameters ${CFT_Parameters[@]}           \
        --capabilities ${Capabilities[@]}       \
        --tags ${TAGS[@]}           \
        ${AWSPROFILEREGION}
    )
    echo ''

    aws cloudformation create-stack \
        --stack-name ${StackName_DeploymentRole}   \
        --no-disable-rollback       \
        --output json               \
        --template-body file://${CFT_Filename}  \
        --parameters ${CFT_Parameters[@]}           \
        --capabilities ${Capabilities[@]}       \
        --tags ${TAGS[@]}           \
        ${AWSPROFILEREGION}
    ###----------------------------
else
    ###----------------------------
    echo "[♺] UPDATE STACK."
    printf "\e[2m%s \e[22m" $( echo \
    aws cloudformation update-stack \
        --stack-name ${StackName_DeploymentRole}   \
        --no-disable-rollback       \
        --output json               \
        --template-body file://${CFT_Filename}  \
        --parameters ${CFT_Parameters[@]}           \
        --capabilities ${Capabilities[@]}       \
        --tags ${TAGS[@]}           \
        ${AWSPROFILEREGION}
    )
    echo ''

    aws cloudformation update-stack \
        --stack-name ${StackName_DeploymentRole}   \
        --no-disable-rollback       \
        --output json               \
        --template-body file://${CFT_Filename}  \
        --parameters ${CFT_Parameters[@]}           \
        --capabilities ${Capabilities[@]}       \
        --tags ${TAGS[@]}           \
        ${AWSPROFILEREGION}
fi

###--------------------------------------------------------
###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
###--------------------------------------------------------

exit $?

### EoScript