# This license BELOW applies to all content within ./test-deploy-to-aws
# subfolder-tree, as long as it does NOT conflict with the LICENSE defined
# in the LICENSE-file that is located in the topmost folder of this Git-Repo.
# ________________________________________________________________________
# BSD 3-Clause License

# Copyright (c) 2019, org.ASUX
# All rights reserved.

# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:

# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the following disclaimer.

# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.

# 3. Neither the name of the copyright holder nor the names of its
#    contributors may be used to endorse or promote products derived from
#    this software without specific prior written permission.

# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

AWSTemplateFormatVersion: 2010-09-09

Parameters:

  ENV:
    Type: String
    Default: PROD

  RoleName:
    Type: String
    Description: >-
      Name of Role used by CloudFormation, to Deploy a stack for
      ClamAV-Malware-Scanner
      Example: "ClamAV-Malware-Scanner-CDKDeploy"

  PermissionsBoundaryPolicyARN:
    Type: String
    Description: >-
      The ARN to the IAM-Policy that should be applied as the Permissions
      Boundary when creating this new ROLES in AWS Account

Resources:

  DeployRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: 'sts:AssumeRole'
 
      RoleName: !Ref RoleName
      PermissionsBoundary: !Ref PermissionsBoundaryPolicyARN ### !! ATTENTION !! Must enable this for CloudBoost and other 
      Path: /
 
      Policies:
        - PolicyName: deploy-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              # - Sid: PassRoleForInitiator
                # Effect: Allow
                # Resource:
                #   - "*"
                #   # - !Sub "arn:${AWS::Partition}:sts::${AWS::AccountId}:assumed-role/cdk-*"
                # Action:
                #   - 'iam:PassRole'

              - Sid: PassRoleForClamAVFargate
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/ClamAV-*"
                  # - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/ClamAV-Malware-Scanner-CD-ClamAVServerlessClamscanS"
                Action:
                  - 'iam:PassRole'

              - Sid: IAMActions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/*"
                  - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/*"
                Action:
                  - 'iam:AttachRolePolicy*'
                  - 'iam:CreatePolicy*'
                  - 'iam:CreateRole*'
                  - 'iam:UpdateRole*'
                  - 'iam:AttachRolePolicy*'
                  - 'iam:PutRolePolicy*'
                  - 'iam:DetachRolePolicy*'
                  - 'iam:DeletePolicy*'
                  - 'iam:DeleteRole*'
                  - 'iam:CreateServiceLinkedRole*'
                  - 'iam:DeleteServiceLinkedRole*'
                  - 'iam:CreateOpenIDConnectProvider*'
                  - 'iam:DeleteOpenIDConnectProvider*'
                  - 'iam:PutRolePermissionsBoundary*'
                  - 'iam:DeleteRolePermissionsBoundary*'
                  - 'iam:GetRole*'
                  - 'iam:TagPolicy*'
                  - 'iam:TagRole*'
                  - 'iam:UntagPolicy*'
                  - 'iam:UntagRole*'
                  - 'iam:DeleteTag*'

              - Sid: CloudFormationActions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:stack*"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:changeSet*"
                Action:
                  - 'cloudformation:Create*'
                  - 'cloudformation:Update*'
                  - 'cloudformation:Delete*'
                  - 'cloudformation:Stop*'
                  - 'cloudformation:RollbackStack'
                  - 'cloudformation:CancelUpdateStack'
                  - 'cloudformation:ExecuteChangeSet'
                  - 'cloudformation:Tag*'
                  - 'cloudformation:Untag*'
                  - 'cloudformation:Describe*'

              - Sid: CWLogsActions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:*"
                Action:
                  - 'logs:CreateLogGroup*'
                  - 'logs:DeleteLogGroup*'
                  - 'logs:DescribeLogGroup*'
                  - 'logs:TagResource*'
                  - 'logs:UntagResource*'
                  - 'logs:DeleteTag*'
                  - 'logs:Put*'
                  - 'logs:DescribeLogStreams*'
                  # logs:PutLogEvents 
                  # logs:CreateLogStream 

              - Sid: SSMActions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/cdk-bootstrap/*"
                Action:
                  - 'ssm:GetParameters*'

              - Sid: VPCActions1
                Effect: Allow
                Resource:
                  - '*'
                  # - !Sub "arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:*"
                  # - !Sub "arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:vpc/*"
                Action:
                  - 'ec2:*'
                  # - 'ec2:CreateVpc*'
                  # - 'ec2:CreateSubnet*'
                  # - 'ec2:CreateRoute*'
                  # - 'ec2:DescribeAvailabilityZones*'
                  # - 'ec2:DescribeSecurityGroups*'
                  # - 'ec2:DeleteVpc*'
                  # - 'ec2:ModifyVpcAttribute*'
                  # - 'ec2:CreateTags*'
                  # - 'ec2:DeleteTags*'
                  # - 'ec2:AuthorizeSecurityGroupEgress*'
                  # - 'ec2:AuthorizeSecurityGroupIngress*'
                  # - 'ec2:RevokeSecurityGroupEgress*'
                  # - 'ec2:RevokeSecurityGroupIngress*'
                  # - 'elasticfilesystem:ClientWrite*'

              - Sid: VPCActions22
                Effect: Allow
                Resource:
                  - "*"
                Action:
                  - 'ec2:DescribeVpcs*'

              - Sid: LambdaActions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:layer:*"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:event-source-mapping:*"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:code-signing-config:*"
                Action:
                  - 'lambda:Add*'
                  - 'lambda:Create*'
                  - 'lambda:Publish*'
                  - 'lambda:Put*'
                  - 'lambda:GetFunction'
                  - 'lambda:InvokeFunction'
                  - 'lambda:Update*'
                  - 'lambda:Remove*'
                  - 'lambda:Delete*'
                  - 'lambda:Tag*'
                  - 'lambda:Untag*'
                  - 'lambda:DeleteTag*'

              - Sid: SQSActions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:*"
                Action:
                  - 'sqs:Add*'
                  - 'sqs:Create*'
                  - 'sqs:Delete*'
                  - 'sqs:Remove*'
                  - 'sqs:GetQueueAttributes'
                  - 'sqs:SetQueueAttributes*'
                  - 'sqs:Tag*'
                  - 'sqs:Untag*'
                  - 'sqs:DeleteTag*'
                  # sqs:GetQueueAttributes 
                  # sqs:GetQueueUrl 
                  # sqs:SendMessage 

              - Sid: S3Actions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::*"
                Action:
                  - 's3:CreateBucket*'
                  - 's3:DeleteBucket*'
                  - 's3:PutBucket*'
                  - 's3:PutEncryptionConfig*'
                  - 's3:PutIntelligent*'
                  - 's3:PutRreplication*'
                  - 's3:RreplicateDelete*'
                  - 's3:RreplicateTags*'
                  - 's3:Tag*'
                  - 's3:Untag*'
                  - 's3:DeleteTag*'
                  - 's3:GetObject*'
                  - 's3:GetBucket*'
                  # s3:List*
                  # s3:PutBucketNotification 
                  # s3:PutBucketPolicy 
                  # s3:DeleteObject*
                  # s3:PutObject 
                  # s3:PutObjectTagging 
                  # s3:PutObjectVersionTagging 
                  # s3:PutObjectLegalHold 
                  # s3:PutObjectRetention 
                  # s3:Abort*

              - Sid: EFSActions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:elasticfilesystem:${AWS::Region}:${AWS::AccountId}:file-system/*"
                  - !Sub "arn:${AWS::Partition}:elasticfilesystem:${AWS::Region}:${AWS::AccountId}:access-point/*"
                Action:
                  - 'elasticfilesystem:Create*'
                  - 'elasticfilesystem:PutFileSystem*'
                  - 'elasticfilesystem:DeleteFileSystem*'
                  - 'elasticfilesystem:DeleteMount*'
                  - 'elasticfilesystem:DeleteAccessPoint*'
                  - 'elasticfilesystem:PutLifecycleConfiguration*'
                  - 'elasticfilesystem:DescribeFileSystems*'
                  - 'elasticfilesystem:DescribeAccessPoint*'
                  - 'elasticfilesystem:DescribeMount*'
                  - 'elasticfilesystem:Tag*'
                  - 'elasticfilesystem:Untag*'
                  - 'elasticfilesystem:DeleteTag*'
                  # elasticfilesystem:ClientRootAcces
                  # elasticfilesystem:ClientWrite 
                  # elasticfilesystem:ClientMoun

              - Sid: EventBridgeActions
                Effect: Allow
                Resource:
                  - !Sub "arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:event-bus/*"
                  - !Sub "arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/*"
                Action:
                  - 'events:CreateEventBus*'
                  - 'events:DeleteEventBus*'
                  - 'events:PutRule*'
                  - 'events:PutTargets*'
                  - 'events:DeleteRule*'
                  - 'events:RemoveTargets*'
                  - 'events:DescribeEventBus*'
                  - 'events:DescribeRule*'
                  - 'events:Tag*'
                  - 'events:Untag*'
                  - 'events:DeleteTag*'
                  # events:PutEvents 

### EoF
