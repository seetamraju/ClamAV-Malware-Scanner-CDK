# LICENSE

Read the file [LICENSE](./LICENSE) now.

# What is this folder and HOW-TO

IMPORTANT: See [sub-section on create-deploy-role](#step-4-run-bincreate-deploy-iamrolesh) below, for CRITICAL info for Enterprise-environments !!!

<HR/>

Qn: Why this subfolder?<BR/>
Ans: The `../test` folder does LOCAL testing based on `jest`, on the Cloudformation GENERATED (and eventually packaged into the `.whl` deployable for Python-CDK Construct)

If you customize anything in here -- to state the obvious -- we need to deploy the UPDATED CDK-Construct onto AWS, ..<BR/>
.. to verify nothing broke when we changed the code here.

That's what this sub-folder `test-deploy-to-aws` is all about.

# Step  - Pre-Requisite: In Parent folder

Attention: You must be in the PARENT folder (of this README) to run the following command.

```bash
npm run build
```

# Step 1: `cd ./test-deploy-to-aws`

# Step 2: Update `bin/common-settings.sh`

This is a must-do.

# Step 3: `.  ./bin/init.sh`

This will UTILIZE the updated CDK-Construct, and generate the `cdk.out` representing a deployable STACK.<BR>
This stack is very minimal:
1. Contains a dummy bucket
1. Contains the AWS-Resources createad by `ServerlessClamscan` Construct.
Nothing more.

# Step 4: Run `./bin/create-deploy-iamrole.sh`

This creates an IAM-role that is --used-- by the (following) `bin/deploy.sh` script, to deploy cloudformation.

There are 2 objectives of NOT relying on you utilizing your FULL-ADMIN privileges.

1. The obvious: Principle of Least Privilege.  Something you see all the time on AWS Documentation.
1. In enterprise-scenarios, people need to know what privileges are needed to:
    1.  to create this construct.
    1.  to update this construct.
    1.  to destroy this construct.

# Step 5: Run `./bin/deploy.sh`

# Clean Up: Run `./bin/clean.sh`

<HR/>
<HR/>
<HR/>
<HR/>

# Appendix: Justification for contents of IAM-Role.

Re: [IAM-Role JSON file](./etc/cdk-deploy-iam-role-CFT.json)

Here's the errors that lead to the Access-Statements in it.

```
CdkStack: deploying... [1/1]
CdkStack: creating CloudFormation changeset...

 ❌  CdkStack failed: AccessDenied: User: arn:aws:sts::591580567012:assumed-role/cdk-hnb659fds-deploy-role-591580567012-us-east-2/aws-cdk-test is not authorized to perform: iam:PassRole on resource: arn:aws:iam::591580567012:role/ClamAV-Malware-Scanner_CDK-Deploy because no identity-based policy allows the iam:PassRole action

9:12:03 PM | CREATE_FAILED        | AWS::EFS::FileSystem                  | ClamAVServerlessCl...FileSystem52F92282
Resource handler returned message: "User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: elasticfilesystem:TagRe
source on the specified resource (Service: Efs, Status Code: 403, Request ID: cb47cb8e-2149-401d-99bd-ea4e694707b0)" (RequestToken: 0390a822-e5cd-3e58-4c1f-a39a090c9b16, HandlerErrorCode
: GeneralServiceException)

9:12:03 PM | CREATE_FAILED        | AWS::EC2::VPC                         | ClamAVServerlessClamscanScanVPC9CE28EB8
Resource handler returned message: "You are not authorized to perform this operation. User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is
not authorized to perform: ec2:CreateVpc on resource: arn:aws:ec2:us-east-2:591580567012:vpc/* because no identity-based policy allows the ec2:CreateVpc action. Encoded authorization fai
lure message: wFGMenKibAKFNNJqbrUuN8_S8t3seJFfvugO0OcMubQuCC7P45yb239m6fuzUJqx2fLMMy57AanYqenZXCIcFTXC0tQ_wqgz93Ssa_wf6e5CkKcgMQqePCmNZ1xGqh0tUk9Ft6d43sbr_BfranqLzRXhej45Ej9p5GbYTzPes2gY
2tRXq6lEAUvMc48w9SDDQ7WhkoPERQK4LxvF79FggRJX8vG4VO64jOlK8zKmgMX4Kjq-4BXwSfEUMmFy3p6PuJktdoF74f8jTwLbGoff76D26fX3F5Dre8TKBVGa-gIW6AgsA3ej2sQYyMuLoxto10LyNXjIl8x0UdH_vSO3Nc8zTWhx1p5E7U-4G4
C_dOIzKpsHBnWQw3LRk2FqQlxBrLNMZIMbR66poRCWlJBWiJ5ErwdMT30hQ9rofSenhADPwFGloBKVMgW24mgLxIgcJn_eug2g8yy4GahtLaiUyHnnPbDXqRFAKyYsTzN0aVThes2UHbJyl28L9iBaHe8eKVaVWvJm8fXXFBH236T-cM4J2OP7FyVP
nPTgKOPckFGFhMU (Service: Ec2, Status Code: 403, Request ID: dd966fbc-1fce-4c61-87f0-3879902703e9)" (RequestToken: ea3c6b29-139b-051d-1977-26a4a9516746, HandlerErrorCode: AccessDenied)

9:12:03 PM | CREATE_FAILED        | AWS::Events::EventBus                 | ClamAVServerlessCl...nResultBus7A815431
Resource handler returned message: "User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: events:DescribeEventBus
on resource: arn:aws:events:us-east-2:591580567012:event-bus/CdkStackClamAVServerlessClamscanScanResultBus04ACEBC2 because no identity-based policy allows the events:DescribeEventBus act
ion (Service: EventBridge, Status Code: 400, Request ID: 9aed4a75-d39c-4005-82e2-d7442f8e4ab5)" (RequestToken: 2cd59e74-61c7-d110-6a1a-ad4baf15c940, HandlerErrorCode: AccessDenied)

9:12:03 PM | CREATE_FAILED        | AWS::SQS::Queue                       | ClamAVServerlessCl...etterQueueD4D0248C
Resource handler returned message: "User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: sqs:getqueueattributes
on resource: arn:aws:sqs:us-east-2:591580567012:CdkStack-ClamAVServerlessClamscanScanErrorDeadLetterQueueD4D0248C-j3OMqUCDCIM1 because no identity-based policy allows the sqs:getqueueatt
ributes action (Service: Sqs, Status Code: 403, Request ID: 50ef62a7-123f-5ca4-a548-3c4b209c3deb)" (RequestToken: 4795fb9a-3283-70dd-3fd9-b970e1e0589a, HandlerErrorCode: AccessDenied)

9:12:07 PM | DELETE_FAILED        | AWS::Events::EventBus                 | ClamAVServerlessCl...nResultBus7A815431
Resource handler returned message: "User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: events:DescribeEventBus
on resource: arn:aws:events:us-east-2:591580567012:event-bus/CdkStackClamAVServerlessClamscanScanResultBus04ACEBC2 because no identity-based policy allows the events:DescribeEventBus act
ion (Service: EventBridge, Status Code: 400, Request ID: 5daf8127-7d28-4aca-ba32-5724c612fe1a)" (RequestToken: 02ad20c2-c486-be94-ee59-08e7b09581a2, HandlerErrorCode: InvalidRequest)


 ❌  CdkStack failed: Error: The stack named CdkStack failed creation, it may need to be manually deleted from the AWS console: ROLLBACK_FAILED (The following resource(s) failed to delete: [ClamAVServerlessClamscanScanResultBus7A815431]. ): Resource handler returned message: "User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: elasticfilesystem:TagResource on the specified resource (Service: Efs, Status Code: 403, Request ID: cb47cb8e-2149-401d-99bd-ea4e694707b0)" (RequestToken: 0390a822-e5cd-3e58-4c1f-a39a090c9b16, HandlerErrorCode: GeneralServiceException), Resource handler returned message: "You are not authorized to perform this operation. User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: ec2:CreateVpc on resource: arn:aws:ec2:us-east-2:591580567012:vpc/* because no identity-based policy allows the ec2:CreateVpc action. Encoded authorization failure message: wFGMenKibAKFNNJqbrUuN8_S8t3seJFfvugO0OcMubQuCC7P45yb239m6fuzUJqx2fLMMy57AanYqenZXCIcFTXC0tQ_wqgz93Ssa_wf6e5CkKcgMQqePCmNZ1xGqh0tUk9Ft6d43sbr_BfranqLzRXhej45Ej9p5GbYTzPes2gY2tRXq6lEAUvMc48w9SDDQ7WhkoPERQK4LxvF79FggRJX8vG4VO64jOlK8zKmgMX4Kjq-4BXwSfEUMmFy3p6PuJktdoF74f8jTwLbGoff76D26fX3F5Dre8TKBVGa-gIW6AgsA3ej2sQYyMuLoxto10LyNXjIl8x0UdH_vSO3Nc8zTWhx1p5E7U-4G4C_dOIzKpsHBnWQw3LRk2FqQlxBrLNMZIMbR66poRCWlJBWiJ5ErwdMT30hQ9rofSenhADPwFGloBKVMgW24mgLxIgcJn_eug2g8yy4GahtLaiUyHnnPbDXqRFAKyYsTzN0aVThes2UHbJyl28L9iBaHe8eKVaVWvJm8fXXFBH236T-cM4J2OP7FyVPnPTgKOPckFGFhMU (Service: Ec2, Status Code: 403, Request ID: dd966fbc-1fce-4c61-87f0-3879902703e9)" (RequestToken: ea3c6b29-139b-051d-1977-26a4a9516746, HandlerErrorCode: AccessDenied), Resource handler returned message: "User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: events:DescribeEventBus on resource: arn:aws:events:us-east-2:591580567012:event-bus/CdkStackClamAVServerlessClamscanScanResultBus04ACEBC2 because no identity-based policy allows the events:DescribeEventBus action (Service: EventBridge, Status Code: 400, Request ID: 9aed4a75-d39c-4005-82e2-d7442f8e4ab5)" (RequestToken: 2cd59e74-61c7-d110-6a1a-ad4baf15c940, HandlerErrorCode: AccessDenied), Resource handler returned message: "User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: sqs:getqueueattributes on resource: arn:aws:sqs:us-east-2:591580567012:CdkStack-ClamAVServerlessClamscanScanErrorDeadLetterQueueD4D0248C-j3OMqUCDCIM1 because no identity-based policy allows the sqs:getqueueattributes action (Service: Sqs, Status Code: 403, Request ID: 50ef62a7-123f-5ca4-a548-3c4b209c3deb)" (RequestToken: 4795fb9a-3283-70dd-3fd9-b970e1e0589a, HandlerErrorCode: AccessDenied), Resource handler returned message: "User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner_CDK-Deploy/AWSCloudFormation is not authorized to perform: events:DescribeEventBus on resource: arn:aws:events:us-east-2:591580567012:event-bus/CdkStackClamAVServerlessClamscanScanResultBus04ACEBC2 because no identity-based policy allows the events:DescribeEventBus action (Service: EventBridge, Status Code: 400, Request ID: 5daf8127-7d28-4aca-ba32-5724c612fe1a)" (RequestToken: 02ad20c2-c486-be94-ee59-08e7b09581a2, HandlerErrorCode: InvalidRequest)
    at FullCloudFormationDeployment.monitorDeployment (/opt/homebrew/Cellar/aws-cdk/2.146.0/libexec/lib/node_modules/aws-cdk/lib/index.js:451:10568)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async Object.deployStack2 [as deployStack] (/opt/homebrew/Cellar/aws-cdk/2.146.0/libexec/lib/node_modules/aws-cdk/lib/index.js:454:199716)
    at async /opt/homebrew/Cellar/aws-cdk/2.146.0/libexec/lib/node_modules/aws-cdk/lib/index.js:454:181438

10:21:12 PM | DELETE_FAILED        | AWS::EC2::VPC                         | ClamAVServerlessClamscanScanVPC9CE28EB8
Resource handler returned message: "You are not authorized to perform this operation. User: arn:aws:sts::591580567012:assumed-role/ClamAV-Malware-Scanner-CDKDeploy/AWSCloudFormation is n
ot authorized to perform: ec2:DescribeVpcs because no identity-based policy allows the ec2:DescribeVpcs action (Service: Ec2, Status Code: 403, Request ID: 66c6afc7-7105-4976-971a-78bda0
0e41b4)" (RequestToken: d20b094d-8048-a915-f546-d927db0e7783, HandlerErrorCode: AccessDenied)

```

# EoF
